#!/bin/bash

# Uses japi-compliance-checker, https://github.com/lvc/japi-compliance-checker,
# to check API compliance between two git commits
#
# Usage: api-compliance-between <OLD_COMMIT> <NEW_COMMIT>
#
# Assumptions:
# * Works for java brazil packages that have a `compile-jar` target which builds the jars
# * ionsql-sandbox-single.jar must be generated by compile-jar
#

TEMP_DIR="/tmp/japi_temp/"
LIB=${PWD##*/}

command_exists() {
    type "$1" &> /dev/null ;
}

compile_and_copy() {
  CI=$1
  git checkout $CI
  brazil-build single-jar
  cp build/lib/ionsql-sandbox-single.jar $TEMP_DIR/$CI.jar
}

if ! command_exists japi-compliance-checker; then
  echo "japi-compliance-checker not found in PATH, follow installation instructions in https://github.com/lvc/japi-compliance-checker"
  exit 1
fi

OLD_COMMIT=$1
NEW_COMMIT=$2

# makes folder to store .jars to compare
mkdir -p $TEMP_DIR

compile_and_copy $OLD_COMMIT
compile_and_copy $NEW_COMMIT

japi-compliance-checker --lib $LIB --old $TEMP_DIR/$OLD_COMMIT.jar --new $TEMP_DIR/$NEW_COMMIT.jar

# clean up
rm -rf  $TEMP_DIR
